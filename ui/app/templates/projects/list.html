{% extends "base.html" %}

{% block title %}Projects - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Research Projects</h1>
    <p class="page-description">
        Browse all analysis projects exploring BERDL data collections.
        Each project addresses a specific research question using the KBase Data Lakehouse.
    </p>
</div>

<div class="sort-controls">
    <span class="sort-label">Sort by:</span>
    <a href="?sort=recent" class="sort-option {% if current_sort == 'recent' %}active{% endif %}">Recent Activity</a>
    <a href="?sort=status" class="sort-option {% if current_sort == 'status' %}active{% endif %}">Status</a>
    <a href="?sort=alpha" class="sort-option {% if current_sort == 'alpha' %}active{% endif %}">Alphabetical</a>
    <input type="text" id="project-search" class="search-input" placeholder="Search projects..." aria-label="Search projects">
</div>

<p id="no-search-results" class="text-muted" style="display: none;">No projects match your search.</p>

<div class="grid grid-2" id="project-grid">
    {% for project in projects %}
    <article class="card" data-search-text="{{ project.title | lower }} {{ project.id | replace('_', ' ') }} {{ project.research_question | lower }} {{ (project.findings or '')[:500] | lower }} {{ project.status.value | lower }}">
        <div class="card-header">
            <h3 class="card-title">
                <a href="/projects/{{ project.id }}">{{ project.title | markdown_inline }}</a>
            </h3>
            {% if project.status.value == "Completed" %}
            <span class="badge badge-completed">{{ project.status.value }}</span>
            {% elif project.status.value == "In Progress" %}
            <span class="badge badge-in-progress">{{ project.status.value }}</span>
            {% else %}
            <span class="badge badge-proposed">{{ project.status.value }}</span>
            {% endif %}
            {% if project.review_status.value == "Reviewed" %}
            <span class="badge badge-reviewed">{{ project.review_status.value }}</span>
            {% elif project.review_status.value == "Needs Re-review" %}
            <span class="badge badge-needs-re-review">{{ project.review_status.value }}</span>
            {% endif %}
        </div>

        <!-- Project ID and file presence badges -->
        <div style="margin-bottom: var(--space-4);">
            <span class="badge badge-project">{{ project.id | replace('_', ' ') | title }}</span>
            {% if project.has_research_plan %}
            <span class="badge badge-in-progress" style="margin-left: var(--space-1); font-size: 0.65rem;">Plan</span>
            {% endif %}
            {% if project.has_report %}
            <span class="badge badge-completed" style="margin-left: var(--space-1); font-size: 0.65rem;">Report</span>
            {% endif %}
        </div>

        <div class="card-content">
            <h4>Research Question</h4>
            <div class="markdown-content">{{ project.research_question | markdown }}</div>

            {% if project.findings and 'to be filled' not in project.findings.lower() %}
            <h4>Key Findings</h4>
            <div class="markdown-content">{{ project.findings[:500] | strip_images | truncate(300) | markdown }}</div>
            {% endif %}
        </div>

        <div class="card-footer">
            <div class="card-meta">
                {% if project.contributors %}
                <span>{{ project.contributors|length }} author{% if project.contributors|length != 1 %}s{% endif %}</span>
                {% endif %}
                {% if project.notebooks %}
                <span>{{ project.notebooks|length }} notebook{% if project.notebooks|length != 1 %}s{% endif %}</span>
                {% endif %}
                {% if project.visualizations %}
                <span>{{ project.visualizations|length }} figure{% if project.visualizations|length != 1 %}s{% endif %}</span>
                {% endif %}
                {% if project.data_files %}
                <span>{{ project.data_files|length }} data file{% if project.data_files|length != 1 %}s{% endif %}</span>
                {% endif %}
                {% if project.related_collections %}
                <span>{{ project.related_collections|length }} collection{% if project.related_collections|length != 1 %}s{% endif %}</span>
                {% endif %}
            </div>
            <a href="/projects/{{ project.id }}" class="btn btn-primary">View Project</a>
        </div>
    </article>
    {% else %}
    <p class="text-muted">No projects found.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var input = document.getElementById('project-search');
    var grid = document.getElementById('project-grid');
    var noResults = document.getElementById('no-search-results');
    if (!input || !grid) return;

    var cards = grid.querySelectorAll('.card[data-search-text]');

    input.addEventListener('input', function() {
        var query = this.value.toLowerCase().trim();
        var visible = 0;

        cards.forEach(function(card) {
            if (!query || card.getAttribute('data-search-text').indexOf(query) !== -1) {
                card.style.display = '';
                visible++;
            } else {
                card.style.display = 'none';
            }
        });

        noResults.style.display = visible === 0 && query ? '' : 'none';
    });
})();
</script>
{% endblock %}
