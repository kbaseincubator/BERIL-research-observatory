{% extends "base.html" %}

{% block title %}{{ project.title }} - {{ app_name }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-8">
    <a href="/projects" class="text-muted">Projects</a>
    <span class="text-muted"> / </span>
    <span>{{ project.title }}</span>
</nav>

<div class="page-header">
    <div class="flex items-center gap-4 mb-4">
        <h1 class="page-title" style="margin-bottom: 0;">{{ project.title }}</h1>
        {% if project.status.value == "Completed" %}
        <span class="badge badge-completed">{{ project.status.value }}</span>
        {% elif project.status.value == "In Progress" %}
        <span class="badge badge-in-progress">{{ project.status.value }}</span>
        {% else %}
        <span class="badge badge-proposed">{{ project.status.value }}</span>
        {% endif %}
    </div>
    <div style="margin-top: var(--space-2);">
        <span class="text-muted text-small">Project:</span>
        <span class="badge badge-project" style="margin-left: var(--space-2);">
            {{ project.id | replace('_', ' ') | title }}
        </span>
        <!-- File presence badges -->
        {% if project.has_research_plan %}
        <span class="badge badge-in-progress" style="margin-left: var(--space-1);">Plan</span>
        {% endif %}
        {% if project.has_report %}
        <span class="badge badge-completed" style="margin-left: var(--space-1);">Report</span>
        {% endif %}
        {% if project.review %}
        <span class="badge badge-reviewed" style="margin-left: var(--space-1);">Reviewed</span>
        {% endif %}
    </div>
</div>

<!-- Research Question -->
<section class="section">
    <h2>Research Question</h2>
    <div class="page-description markdown-content">{{ project.research_question | markdown }}</div>
</section>

<!-- Overview (from README) -->
{% if project.overview %}
<section class="section">
    <h2>Overview</h2>
    <div class="card markdown-content">
        {{ project.overview | markdown }}
    </div>
</section>
{% endif %}

<!-- === PRIMARY CONTENT: Adapts based on project status === -->

{% if project.has_report and project.findings and 'to be filled' not in project.findings.lower() %}
{# === COMPLETED PROJECT: Center on REPORT.md === #}

<!-- Key Findings (from REPORT.md) -->
<section class="section">
    <h2>Key Findings</h2>
    <div class="card markdown-content" style="border-left: 4px solid var(--accent-primary);">
        {{ project.findings | markdown }}
    </div>
</section>

<!-- Results (from REPORT.md) -->
{% if project.results %}
<section class="section">
    <h2>Results</h2>
    <div class="card markdown-content">
        {{ project.results | markdown }}
    </div>
</section>
{% endif %}

<!-- Interpretation (from REPORT.md) -->
{% if project.interpretation %}
<section class="section">
    <h2>Interpretation</h2>
    <div class="card markdown-content">
        {{ project.interpretation | markdown }}
    </div>
</section>
{% endif %}

<!-- Future Directions (from REPORT.md) -->
{% if project.future_directions %}
<section class="section">
    <h2>Future Directions</h2>
    <div class="card markdown-content">
        {{ project.future_directions | markdown }}
    </div>
</section>
{% endif %}

<!-- Research Plan (collapsible, secondary for completed projects) -->
{% if project.hypothesis or project.approach %}
<section class="section">
    <details>
        <summary style="cursor: pointer; font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-4);">Research Plan</summary>
        {% if project.hypothesis %}
        <div class="card markdown-content" style="margin-bottom: var(--space-4);">
            <h4>Hypothesis</h4>
            {{ project.hypothesis | markdown }}
        </div>
        {% endif %}
        {% if project.approach %}
        <div class="card markdown-content" style="margin-bottom: var(--space-4);">
            <h4>Approach</h4>
            {{ project.approach | markdown }}
        </div>
        {% endif %}
        {% if project.revision_history %}
        <div class="card markdown-content">
            <h4>Revision History</h4>
            {{ project.revision_history | markdown }}
        </div>
        {% endif %}
    </details>
</section>
{% endif %}

{% elif project.has_research_plan %}
{# === IN-PROGRESS PROJECT: Center on RESEARCH_PLAN.md === #}

<!-- Hypothesis -->
{% if project.hypothesis %}
<section class="section">
    <h2>Hypothesis</h2>
    <div class="card markdown-content">
        {{ project.hypothesis | markdown }}
    </div>
</section>
{% endif %}

<!-- Approach -->
{% if project.approach %}
<section class="section">
    <h2>Approach</h2>
    <div class="card markdown-content">
        {{ project.approach | markdown }}
    </div>
</section>
{% endif %}

<!-- Revision History -->
{% if project.revision_history %}
<section class="section">
    <h2>Revision History</h2>
    <div class="card markdown-content">
        {{ project.revision_history | markdown }}
    </div>
</section>
{% endif %}

<!-- Partial findings if they exist -->
{% if project.findings and 'to be filled' not in project.findings.lower() %}
<section class="section">
    <h2>Key Findings</h2>
    <div class="card markdown-content" style="border-left: 4px solid var(--accent-primary);">
        {{ project.findings | markdown }}
    </div>
</section>
{% endif %}

{% else %}
{# === PROPOSED/LEGACY PROJECT: Show what's available from README === #}

{% if project.hypothesis %}
<section class="section">
    <h2>Hypothesis</h2>
    <div class="card markdown-content">
        {{ project.hypothesis | markdown }}
    </div>
</section>
{% endif %}

{% if project.approach %}
<section class="section">
    <h2>Approach</h2>
    <div class="card markdown-content">
        {{ project.approach | markdown }}
    </div>
</section>
{% endif %}

{% if project.findings and 'to be filled' not in project.findings.lower() %}
<section class="section">
    <h2>Key Findings</h2>
    <div class="card markdown-content" style="border-left: 4px solid var(--accent-primary);">
        {{ project.findings | markdown }}
    </div>
</section>
{% endif %}

{% endif %}

<!-- Authors -->
{% if project.contributors %}
<section class="section">
    <h2>Authors</h2>
    <div class="contributors-list">
        {% for contributor in project.contributors %}
        <div class="contributor-card">
            <div class="contributor-info">
                <span class="contributor-name">{{ contributor.name }}</span>
                {% if contributor.affiliation %}
                <span class="contributor-affiliation">({{ contributor.affiliation }})</span>
                {% endif %}
            </div>
            <div class="contributor-meta">
                {% if contributor.orcid %}
                <a href="{{ contributor.orcid_url }}" target="_blank" rel="noopener" class="orcid-link">
                    <img src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" alt="ORCID" width="16" height="16">
                    {{ contributor.orcid }}
                </a>
                {% endif %}
                {% if contributor.roles %}
                <span class="contributor-roles">{{ contributor.roles | join(', ') }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Discoveries -->
{% if project_discoveries %}
<section class="section">
    <h2>Discoveries</h2>
    {% for discovery in project_discoveries %}
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="card-header">
            <h4 class="card-title" style="margin: 0;">
                <a href="/knowledge/discoveries#{{ discovery.id }}">{{ discovery.title }}</a>
            </h4>
            {% if discovery.date %}
            <span class="text-muted text-small">{{ discovery.date.strftime('%B %Y') }}</span>
            {% endif %}
        </div>
        <div class="card-content markdown-content text-small">
            {{ discovery.content[:300] | markdown }}{% if discovery.content|length > 300 %}
            <a href="/knowledge/discoveries#{{ discovery.id }}" class="text-small">Read more &rarr;</a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Data Collections -->
{% if project.related_collections %}
<section class="section">
    <h2>Data Collections</h2>
    <div class="grid grid-3">
        {% for coll_id in project.related_collections %}
        <a href="/collections/{{ coll_id }}" class="card" style="text-decoration: none;">
            <code style="color: var(--text-primary);">{{ coll_id }}</code>
            <p class="text-small mt-4" style="margin-bottom: 0; color: var(--text-link);">View collection &rarr;</p>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Review -->
{% if project.review %}
<section class="section">
    <h2>Review</h2>
    <div class="review-banner">
        <div class="flex items-center gap-4" style="flex-wrap: wrap;">
            <span class="review-ai-label">AI Review</span>
            <span class="text-muted text-small">{{ project.review.reviewer }}</span>
            {% if project.review.date %}
            <span class="text-muted text-small">{{ project.review.date.strftime('%Y-%m-%d') }}</span>
            {% endif %}
            {% if project.review_status.value == "Reviewed" %}
            <span class="badge badge-reviewed">{{ project.review_status.value }}</span>
            {% elif project.review_status.value == "Needs Re-review" %}
            <span class="badge badge-needs-re-review">{{ project.review_status.value }}</span>
            {% endif %}
        </div>
    </div>

    {% if project.review.summary %}
    <div class="review-card">
        <h4>Summary</h4>
        <div class="markdown-content">{{ project.review.summary | markdown }}</div>
    </div>
    {% endif %}

    {% if project.review.methodology %}
    <div class="review-card">
        <h4>Methodology</h4>
        <div class="markdown-content">{{ project.review.methodology | markdown }}</div>
    </div>
    {% endif %}

    {% if project.review.code_quality %}
    <div class="review-card">
        <h4>Code Quality</h4>
        <div class="markdown-content">{{ project.review.code_quality | markdown }}</div>
    </div>
    {% endif %}

    {% if project.review.findings_assessment %}
    <div class="review-card">
        <h4>Findings Assessment</h4>
        <div class="markdown-content">{{ project.review.findings_assessment | markdown }}</div>
    </div>
    {% endif %}

    {% if project.review.suggestions %}
    <div class="review-card">
        <h4>Suggestions</h4>
        <div class="markdown-content">{{ project.review.suggestions | markdown }}</div>
    </div>
    {% endif %}

    <p class="text-muted text-small" style="margin-top: var(--space-4);">
        This review was generated by an AI system. It should be treated as advisory input, not a definitive assessment.
    </p>
</section>
{% endif %}

<!-- Visualizations -->
{% if project.visualizations %}
<section class="section">
    <h2>Visualizations</h2>
    <div class="grid grid-3">
        {% for viz in project.visualizations %}
        <div class="card" style="padding: var(--space-3);">
            <img
                src="/project-assets/{{ viz.path | replace('projects/', '', 1) }}"
                alt="{{ viz.title }}"
                style="width: 100%; height: auto; border-radius: var(--radius-sm);"
                loading="lazy"
            >
            <p class="text-small text-muted mt-4" style="margin-bottom: 0;">{{ viz.title }}</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Notebooks -->
{% if project.notebooks %}
<section class="section">
    <h2>Notebooks</h2>
    <div class="grid grid-2">
        {% for notebook in project.notebooks %}
        <a href="/projects/{{ project.id }}/notebooks/{{ notebook.filename }}" class="card" style="text-decoration: none;">
            <div class="flex items-center gap-4">
                <span style="font-size: 1.5rem; color: var(--accent-primary);">&#128196;</span>
                <div>
                    <code style="color: var(--text-primary);">{{ notebook.filename }}</code>
                    {% if notebook.title %}
                    <p class="text-muted text-small mt-4" style="margin-bottom: 0;">{{ notebook.title }}</p>
                    {% endif %}
                </div>
            </div>
            <p class="text-small mt-4" style="margin-bottom: 0; color: var(--text-link);">View notebook &rarr;</p>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Data Files -->
{% if project.data_files %}
<section class="section">
    <h2>Data Files</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size</th>
            </tr>
        </thead>
        <tbody>
            {% for file in project.data_files %}
            <tr>
                <td><code>{{ file.filename }}</code></td>
                <td>{{ "%.1f"|format(file.size_bytes / 1024) }} KB</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endif %}
{% endblock %}
