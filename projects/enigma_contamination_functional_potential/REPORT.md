# Report: Contamination Gradient vs Functional Potential in ENIGMA Communities

## Key Findings

### H1 not supported in current genus-level model
Across 108 overlapping ENIGMA samples, primary univariate tests remained non-significant for all four outcomes in both mapping modes.

![Stress score vs contamination index by mapping mode](figures/contamination_vs_functional_score.png)

- `relaxed_all_clades`, `site_defense_score`: rho = 0.0587, Spearman p = 0.546, permutation p = 0.531, OLS p = 0.0681
- `strict_single_clade`, `site_defense_score`: rho = 0.0682, Spearman p = 0.483, permutation p = 0.463, OLS p = 0.127
- `site_mobilome_score` now has non-zero variance in both modes (no longer `constant_feature`).

*(Notebook: `03_contamination_functional_models.ipynb`)*

### Adjusted sensitivity analyses show a conditional defense signal
After adding confounder and coverage sensitivity checks in NB03, contamination-defense association became significant in selected adjusted models:
- Coverage-adjusted OLS (`contamination + depth + latitude + longitude + mapped_abundance_fraction`):
  - `relaxed_all_clades`: contamination p = 0.000398
  - `strict_single_clade`: contamination p = 0.00354
- High-coverage subset (`mapped_abundance_fraction >= 0.25`):
  - `site_defense_score`: Spearman p = 0.0207 (relaxed), 0.00980 (strict)

Most non-defense outcomes remained non-significant in these sensitivity tests, with one exploratory exception:
- `strict_single_clade`, high-coverage subset (`mapped_abundance_fraction >= 0.25`), `site_stress_score`: Spearman rho = 0.2489, p = 0.0407.

![Mapping and feature coverage by mode](figures/mapping_coverage_by_mode.png)

Coverage diagnostics from upstream outputs:
- 1,392 ENIGMA genera observed
- 530 mapped genera, 862 unmapped genera
- Bridge table rows: 8,242 (many-to-many genus-to-clade expansion)
- Functional feature rows: 3,180 (530 genera x 3 features x 2 modes)
- Mean mapped abundance fraction: 0.343 (range 0.031 to 0.854), comparable across both mapping modes

*(Notebook: `02_taxonomy_bridge_functional_features.ipynb`; data: `taxon_bridge.tsv`, `taxon_functional_features.tsv`)*

### Contamination index was broad but right-skewed
NB03 built contamination index from 8 metal columns (`arsenic`, `cadmium`, `chromium`, `copper`, `lead`, `nickel`, `uranium`, `zinc`) using per-metal `log1p` z-scoring and row-wise mean.

- n = 108 samples
- min = -0.448, max = 3.836
- median = -0.271, IQR = [-0.363, 0.053]

![Distribution of contamination index](figures/contamination_index_distribution.png)

*(Notebook: `03_contamination_functional_models.ipynb`)*

## Results

NB01 extracted and QC-filtered overlap data to 108 samples with both geochemistry and community composition:
- Geochemistry matrix shape: `(108, 49)`
- Community taxon rows: `41,711`
- Distinct communities: `212`
- Distinct genera: `1,392`

NB02 built a genus-normalized bridge to pangenome clades:
- GTDB species rows parsed for genus mapping: `27,690`
- Mapped genera: `530`
- Unmapped genera: `862`
- Strict clades: `530`, relaxed clades: `7,380`
- Functional features now computed independently for strict and relaxed mapping modes.

NB03 produced:
- Site functional score rows: `216` (108 samples x 2 mapping modes)
- Model result rows: `8` (4 outcomes x 2 mapping modes)
- Expanded model diagnostics in `model_results.tsv`: adjusted coordinates/depth models, coverage-adjusted models, site-structure models (`location_prefix`), and high-coverage subset correlations.

Overall, the contamination signal is weak in primary univariate tests but shows a mode-consistent positive association with defense potential under coverage-aware sensitivity models.

## Interpretation

Within this ENIGMA subset, contamination gradients did not translate into a robust community-level shift in inferred stress-related functional potential when features are aggregated at genus resolution from broad COG categories. This is compatible with contamination-driven taxonomic turnover that is functionally redundant or too fine-scale (species/strain/pathway level) for the present mapping.

### Literature Context
- Directionally aligned with prior BERIL ENIGMA work in `projects/lab_field_ecology/REPORT.md`, where contamination effects are evident ecologically but are not guaranteed to collapse into one global functional index.
- The bridge and annotation strategy relies on GTDB taxonomy and eggNOG functional annotation conventions; broad annotation classes can dilute specific metal-stress pathway signal.

### Novel Contribution
This project contributes a reproducible ENIGMA-to-BERDL functional inference workflow with independent strict-vs-relaxed feature construction, mapped-coverage diagnostics, and multi-tier sensitivity modeling beyond basic univariate association tests.

### Limitations
- Genus-level mapping may mask strain-level adaptation.
- 862/1,392 observed genera were unmapped to current pangenome bridge.
- COG-fraction proxies are coarse summaries, not curated resistance pathways.
- Sensitivity-model significance is concentrated in defense and depends on coverage/covariate specification; broader effect across outcomes is not yet established.
- Site structure is represented by coarse `location_prefix` effects rather than full hierarchical/random-effects modeling.

## Data

### Sources
| Collection | Tables Used | Purpose |
|---|---|---|
| `enigma_coral` | `ddt_brick0000010`, `ddt_brick0000459`, `ddt_brick0000454`, `sdt_sample`, `sdt_community`, `sdt_location` | Geochemistry, community composition, taxonomy linkage, and sample metadata |
| `kbase_ke_pangenome` | `gtdb_species_clade`, `pangenome`, `gene_cluster`, `eggnog_mapper_annotations` | Taxonomy bridge and COG-derived functional feature construction |

### Generated Data
| File | Rows | Description |
|---|---:|---|
| `data/geochemistry_sample_matrix.tsv` | 108 | Per-sample geochemistry matrix used for contamination index |
| `data/community_taxon_counts.tsv` | 41,711 | Sample-community-genus abundance table |
| `data/sample_location_metadata.tsv` | 108 | Location/depth metadata for overlapping samples |
| `data/taxon_bridge.tsv` | 8,242 | Genus-to-GTDB species-clade bridge with mapping tier |
| `data/taxon_functional_features.tsv` | 3,180 | Per-genus functional proxy features across two mapping modes |
| `data/site_functional_scores.tsv` | 216 | Site-level functional scores by mapping mode |
| `data/model_results.tsv` | 8 | Spearman/permutation, base OLS, covariate-adjusted OLS, coverage-adjusted OLS, site-structure sensitivity, and high-coverage subset stats |

## Supporting Evidence

### Notebooks
| Notebook | Purpose |
|---|---|
| `notebooks/01_enigma_extraction_qc.ipynb` | ENIGMA overlap extraction and QC export |
| `notebooks/02_taxonomy_bridge_functional_features.ipynb` | Taxonomy bridge and functional feature engineering |
| `notebooks/03_contamination_functional_models.ipynb` | Contamination index construction, modeling, and diagnostics |

### Figures
| Figure | Description |
|---|---|
| `figures/contamination_vs_functional_score.png` | Stress score vs contamination index, faceted by mapping mode |
| `figures/contamination_index_distribution.png` | Histogram of contamination index values across 108 samples |
| `figures/mapping_coverage_by_mode.png` | Number of feature-covered genera per mapping mode |

## Future Directions

1. Replace COG-fraction proxies with curated metal-stress gene sets and pathway-level summaries.
2. Increase taxonomic resolution where possible (species/strain-level bridge) and quantify incremental gains over genus-level mapping.
3. Fit adjusted models with explicit covariates (depth, location cluster, sampling date) and compositional modeling controls.
4. Investigate unmapped genera contribution to contamination gradients and bridge expansion opportunities.
5. Add mixed-effects or hierarchical site models (well/location-level random effects) to test whether defense associations persist under richer structure control.

## References

- Carlson HK et al. (2019). The selective pressures on the microbial community in a metal-contaminated aquifer. *ISME J* 13:937-949. PMID: 30523276.
- Parks DH et al. (2022). GTDB: an ongoing census of bacterial and archaeal diversity through a phylogenetically consistent, rank normalized and complete genome-based taxonomy. *Nucleic Acids Res* 50:D785-D794.
- Cantalapiedra CP et al. (2021). eggNOG-mapper v2: Functional annotation, orthology assignments, and domain prediction at the metagenomic scale. *Mol Biol Evol* 38:5825-5829.
